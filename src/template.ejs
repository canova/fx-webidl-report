<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Firefox WebIDL Report</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="script.js" defer></script>
</head>
<body>
  <header>
    <h1>Firefox WebIDL Report</h1>
  </header>

  <main>
    <% if (!rows.length) { %>
      <p style="text-align:center; font-size:1.25rem; margin-top:2rem;">
        No differences found! ðŸŽ‰
      </p>
    <% } else { %>

      <!-- Summary Cards -->
      <div class="cards">
        <div class="card">
          <h3>Total IDLs in Firefox</h3>
          <div class="value"><%= fxCount %></div>
        </div>
        <div class="card">
          <h3>Total IDLs in WebRef</h3>
          <div class="value"><%= spCount %></div>
        </div>
        <% let changes = {
          'Missing IDL in Firefox': 'missing',
          'Extra IDL in Firefox': 'extra',
          'Member missing in Firefox': 'member',
          'Member additional in Firefox': 'member',
          'Member changed': 'member',
          'Enum value missing in Firefox': 'enum',
          'Enum value additional in Firefox': 'enum'
        }; %>
        <% Object.entries(changes).forEach(([label, key]) => { %>
        <div class="card">
          <h3><%= label %></h3>
          <div class="value">
            <span class="badge <%= key %>">
              <%= rows.filter(r => r.change===label).length %>
            </span>
          </div>
        </div>
        <% }) %>
        <div class="card">
          <h3>Other changes</h3>
          <div class="value">
            <span class="badge other">
              <%= rows.filter(r => !Object.keys(changes).includes(r.change)).length %>
            </span>
          </div>
        </div>
      </div>

      <!-- Filter Input -->
      <div class="filter-section">
        <input
          type="text"
          id="filter-input"
          placeholder="Type to filter listsâ€¦"
        />

        <!-- Collapse/Expand buttons -->
        <div class="toggle-buttons">
          <button id="expandâ€all">Expand All</button>
          <button id="collapseâ€all">Collapse All</button>
        </div>
      </div>

      <!-- Sections -->
      <% function renderSection(title, subset, columns) { %>
        <details open>
          <summary><%= title %> (<%= subset.length %>)</summary>
          <% if (!subset.length) { %>
            <p style="padding:1rem;"><em>None</em></p>
          <% } else { %>
            <div class="table-container">
              <table class="report-table">
                <thead>
                  <tr>
                    <% columns.forEach(c => { %><th><%= c.label %></th><% }) %>
                  </tr>
                </thead>
                <tbody>
                  <% subset.forEach(r => { %>
                  <tr>
                    <% columns.forEach(c => { %>
                      <td><%= c.render(r) %></td>
                    <% }) %>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
        </details>
      <% } %>

      <section>
        <h2>IDLs</h2>
        <% let miss = rows.filter(r => r.change==='Missing IDL in Firefox'); %>
        <% let extra = rows.filter(r => r.change==='Extra IDL in Firefox'); %>
        <%- renderSection('Missing IDLs in Firefox', miss, [
          { label:'Name', render: r => r.defName },
          { label:'Type', render: r => r.defType },
        ]) %>
        <%= renderSection('Extra IDLs in Firefox', extra, [
          { label:'Name', render: r => r.defName },
          { label:'Type', render: r => r.defType },
        ]) %>
      </section>

      <section>
        <h2>Members / Attributes</h2>
        <% let mm = rows.filter(r => r.change==='Member missing in Firefox'); %>
        <% let ma = rows.filter(r => r.change==='Member additional in Firefox'); %>
        <% let mc = rows.filter(r => r.change==='Member changed'); %>
        <%= renderSection('Members missing in Firefox', mm, [
          { label:'Definition', render: r => `${r.defName} (${r.defType})` },
          { label:'Member', render: r => r.member },
        ]) %>
        <%= renderSection('Members additional in Firefox', ma, [
          { label:'Definition', render: r => `${r.defName} (${r.defType})` },
          { label:'Member', render: r => r.member },
        ]) %>
        <%= renderSection('Member differences', mc, [
          { label:'Definition', render: r => `${r.defName} (${r.defType})` },
          { label:'Member', render: r => r.member },
          { label:'Differences', render: r => r.detail },
        ]) %>
      </section>

      <section>
        <h2>Enum Values</h2>
        <% let em = rows.filter(r => r.change==='Enum value missing in Firefox'); %>
        <% let ea = rows.filter(r => r.change==='Enum value additional in Firefox'); %>
        <%= renderSection('Enum values missing in Firefox', em, [
          { label:'Definition', render: r => `${r.defName} (${r.defType})` },
          { label:'Value', render: r => r.member },
        ]) %>
        <%= renderSection('Enum values additional in Firefox', ea, [
          { label:'Definition', render: r => `${r.defName} (${r.defType})` },
          { label:'Value', render: r => r.member },
        ]) %>
      </section>

      <section>
        <% let others = rows.filter(r => !Object.keys(changes).includes(r.change)); %>
        <%= renderSection('Other Changes', others, [
          { label:'Definition', render: r => `${r.defName} (${r.defType})` },
          { label:'Differences', render: r => r.detail },
        ]) %>
      </section>

    <% } %>
  </main>

  <footer>
    <b>Last Update:</b> <%= new Date().toGMTString() %>
  </footer>
</body>
</html>
